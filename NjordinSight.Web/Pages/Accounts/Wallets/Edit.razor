@page "/accounts/{ModelId:int}/edit/wallets"

@inherits ModelListPage<AccountWallet>

<ThemedComponent>
    @if (IsLoading)
    {
        <LoadingSvg />
    }
    else
    {   
        <PageTitle>@(PageTitle.UpdateSingle(ParentAccount.AccountCode).AsPageTitle())</PageTitle>

        <ModelPageHeader Header="@(PageTitle.UpdateMany(ParentAccount.AccountCode))" />

        <CascadingValue Value="@ErrorMessage">
            <ErrorMessageBox Header="@Resources.Strings.Exception_Message_Generic" />
        </CascadingValue>

        <EditForm width="100%" Model="@WorkingEntries">
            <DataAnnotationsValidator/>
            <ActionButtonMenu>
                <button class="form-control button" 
                    @onclick="@(async (args) => await Submit_OnClick(context, args))">
                    @Strings.Caption_Button_Save
                </button>
                <button class="form-control button" 
                    @onclick=@(async (args) => await AddNewAsync(args))>
                    @Strings.Caption_CreateNew.Format(ModelNoun?.GetSingular())
                </button>
                <button class="form-control button" @onclick="Cancel_OnClick"
                    @onclick:preventDefault>
                    @Strings.Caption_Button_Cancel
                </button>
            </ActionButtonMenu>
            <ContentTile>
                <Body>
                    <ValidationSummary />
                    <DataGrid Data="@WorkingEntries">
                        <DataGridColumn Type="DataGridCellType.Button">
                            <CellEditTemplate Context="model">
                                <ToolTip Text="@Strings.Caption_Button_Delete">
                                    <button class="form-control button icon" type="button"
                                        @onclick="async (args) => await DeleteAsync(args, model)">
                                        <IonIcon Name="close-circle" />
                                    </button>
                                </ToolTip>
                            </CellEditTemplate>
                        </DataGridColumn>
                        <DataGridColumn Property=@nameof(AccountWallet.DenominationSecurityId)
                                    Caption=@(ModelMetadata.NameFor<AccountWallet>(x => x.DenominationSecurityId))
                                        width="20%">
                            <CellEditTemplate Context="model">
                                <InputSelect class="form-control"
                                         @bind-Value="@model.DenominationSecurityId">
                                    @foreach (var security in DenominationSecurities)
                                    {
                                        <option value=@security.Key>@security.Display</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For=@(()=> model.DenominationSecurityId) />
                            </CellEditTemplate>
                        </DataGridColumn>
                        <DataGridColumn Property=@nameof(AccountWallet.AddressCode)
                                    Caption=@(ModelMetadata.NameFor<AccountWallet>(x => x.AddressCode))
                                        width="45%">
                            <CellEditTemplate Context="model">
                                <InputText class="form-control" @bind-Value="@model.AddressCode" />
                                <ValidationMessage For=@(()=> model.AddressCode) />
                            </CellEditTemplate>
                        </DataGridColumn>
                        <DataGridColumn Property=@nameof(AccountWallet.AddressTag)
                                    Caption=@(ModelMetadata.NameFor<AccountWallet>(x => x.AddressTag))
                                        width="35%">
                            <CellEditTemplate Context="model">
                                <InputText class="form-control" @bind-Value="@model.AddressTag" />
                                <ValidationMessage For=@(()=> model.AddressTag) />
                            </CellEditTemplate>
                        </DataGridColumn>
                    </DataGrid>
                </Body>
            </ContentTile>
        </EditForm>
    }
</ThemedComponent>

@code {
    [Parameter]
    public int ModelId { get; init; }

    private IEnumerable<LookupModel<int, string>> DenominationSecurities { get; set; }

    private Account ParentAccount { get; set; }

    [Inject]
    protected new ICollectionController<AccountWallet, int> Controller { get; init; }

    protected override async Task OnInitializedAsync()
    {
        // Update the hidden reference to refer the same object to avoid null reference exception.
        base.Controller = Controller;

        CheckNullParameters();

        IsLoading = true;

        try
        {
            ParentAccount = (
                await Controller.ReferenceQueries
                    .GetSingleAsync<Account>(
                        predicate: a => a.AccountId == ModelId,
                        path: a => a.AccountNavigation)).Value;

            var initResult = await Controller.ForParent(ParentAccount.AccountId);

            if (initResult is not OkResult)
                throw new InvalidOperationException();

            var denominationDtosTask = Controller.ReferenceQueries
                .GetCryptocurrencyDTOsAsync();
            var walletsTask = Controller.SelectAsync(predicate: x => true);

            await InitializationTasksAsync(denominationDtosTask, walletsTask);

            var denominationDtoResult = await denominationDtosTask;
            var walletsResult = await walletsTask;

            WorkingEntries = (await walletsTask).Value.Item1.ToList();
            DenominationSecurities = (await denominationDtosTask).Value;

            PaginationHelper.TotalItemCount = (await walletsTask).Value.Item2.ItemCount;
            PaginationHelper.ItemCount = WorkingEntries.Count;
        }
        finally
        {
            IsLoading = WorkingEntries is null || ParentAccount is null || DenominationSecurities is null;
        }
    }
    
    /// <inheritdoc/>
    protected override void Cancel_OnClick() => 
        NavigationHelper.NavigateTo($"{IndexUriRelativePath}/{ModelId}/detail");
}